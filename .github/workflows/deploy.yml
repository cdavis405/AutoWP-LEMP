name: Deploy RetaGuide

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PHP_VERSION: '8.2'
  NODE_VERSION: '18'

jobs:
  test:
    name: Test and Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ env.PHP_VERSION }}
          extensions: mbstring, xml, ctype, json, mysql
          tools: composer, phpcs
      
      - name: Install dependencies
        run: |
          composer install --no-interaction --prefer-dist --optimize-autoloader || true
      
      - name: Run PHPCS
        run: |
          if [ -f "phpcs.xml" ]; then
            phpcs --standard=phpcs.xml wp-content/themes/retaguide/ || true
          else
            echo "PHPCS config not found, skipping..."
          fi
      
      - name: PHP Syntax Check
        run: |
          find wp-content/themes/retaguide -name "*.php" -exec php -l {} \; | grep -v "No syntax errors"
  
  build:
    name: Build Assets
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Cache node modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        run: |
          if [ -f "package.json" ]; then
            npm ci
          fi
      
      - name: Build assets
        run: |
          if [ -f "package.json" ]; then
            npm run build || echo "No build script found"
          fi
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: theme-build
          path: wp-content/themes/retaguide/
          retention-days: 1

  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download build artifacts
        uses: actions/download-artifact@v3
        with:
          name: theme-build
          path: wp-content/themes/retaguide/
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_IP }} >> ~/.ssh/known_hosts
      
      - name: Create backup on server
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }} << 'ENDSSH'
            BACKUP_DIR="/var/backups/retaguide"
            WEB_ROOT="/var/www/retaguide.com"
            TIMESTAMP=$(date +%Y%m%d_%H%M%S)
            
            sudo mkdir -p $BACKUP_DIR
            sudo tar -czf $BACKUP_DIR/theme-backup-$TIMESTAMP.tar.gz -C $WEB_ROOT/wp-content/themes retaguide
            
            # Keep only last 5 backups
            sudo ls -t $BACKUP_DIR/theme-backup-*.tar.gz | tail -n +6 | xargs -r sudo rm
            
            echo "Backup created: theme-backup-$TIMESTAMP.tar.gz"
          ENDSSH
      
      - name: Deploy theme files
        run: |
          rsync -avz --delete \
            --exclude '.git' \
            --exclude 'node_modules' \
            --exclude '.env' \
            --exclude '*.log' \
            wp-content/themes/retaguide/ \
            ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }}:/var/www/retaguide.com/wp-content/themes/retaguide/
      
      - name: Deploy MU plugins
        run: |
          rsync -avz \
            wp-content/mu-plugins/ \
            ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }}:/var/www/retaguide.com/wp-content/mu-plugins/
      
      - name: Set permissions
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }} << 'ENDSSH'
            WEB_ROOT="/var/www/retaguide.com"
            
            sudo chown -R www-data:www-data $WEB_ROOT/wp-content/themes/retaguide
            sudo find $WEB_ROOT/wp-content/themes/retaguide -type d -exec chmod 755 {} \;
            sudo find $WEB_ROOT/wp-content/themes/retaguide -type f -exec chmod 644 {} \;
            
            echo "Permissions set successfully"
          ENDSSH
      
      - name: Clear WordPress cache
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }} << 'ENDSSH'
            WEB_ROOT="/var/www/retaguide.com"
            
            # Clear WordPress cache
            sudo -u www-data wp cache flush --path=$WEB_ROOT --allow-root || true
            
            # Clear NGINX FastCGI cache if exists
            if [ -d "/var/cache/nginx" ]; then
              sudo rm -rf /var/cache/nginx/*
            fi
            
            # Restart PHP-FPM
            sudo systemctl reload php8.2-fpm
            
            echo "Cache cleared successfully"
          ENDSSH
      
      - name: Run post-deployment tasks
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }} << 'ENDSSH'
            WEB_ROOT="/var/www/retaguide.com"
            
            # Flush rewrite rules
            sudo -u www-data wp rewrite flush --path=$WEB_ROOT --allow-root
            
            # Update database if needed
            sudo -u www-data wp core update-db --path=$WEB_ROOT --allow-root || true
            
            echo "Post-deployment tasks completed"
          ENDSSH
      
      - name: Verify deployment
        run: |
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://retaguide.com)
          if [ "$RESPONSE" = "200" ] || [ "$RESPONSE" = "301" ] || [ "$RESPONSE" = "302" ]; then
            echo "✓ Site is responding (HTTP $RESPONSE)"
          else
            echo "✗ Site returned unexpected status: $RESPONSE"
            exit 1
          fi
      
      - name: Send deployment notification
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "✓ Deployment successful"
          else
            echo "✗ Deployment failed"
          fi

  rollback:
    name: Rollback (Manual)
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.AZURE_VM_IP }} >> ~/.ssh/known_hosts
      
      - name: Rollback to previous version
        run: |
          ssh ${{ secrets.AZURE_VM_USER }}@${{ secrets.AZURE_VM_IP }} << 'ENDSSH'
            BACKUP_DIR="/var/backups/retaguide"
            WEB_ROOT="/var/www/retaguide.com"
            
            # Get the latest backup
            LATEST_BACKUP=$(sudo ls -t $BACKUP_DIR/theme-backup-*.tar.gz | head -n 1)
            
            if [ -z "$LATEST_BACKUP" ]; then
              echo "No backup found!"
              exit 1
            fi
            
            echo "Rolling back to: $LATEST_BACKUP"
            
            # Extract backup
            sudo tar -xzf $LATEST_BACKUP -C $WEB_ROOT/wp-content/themes/
            
            # Set permissions
            sudo chown -R www-data:www-data $WEB_ROOT/wp-content/themes/retaguide
            
            # Clear cache
            sudo -u www-data wp cache flush --path=$WEB_ROOT --allow-root || true
            sudo systemctl reload php8.2-fpm
            
            echo "Rollback completed successfully"
          ENDSSH
